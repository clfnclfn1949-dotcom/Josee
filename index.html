<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RIVAL; REVIVAL - ì •ì§í•œ ì¶œíŒ í”Œë«í¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #0A1931; --yellow: #FFC947; --white: #FFFFFF;
      --bg: #F8F9FA; --border: #E9ECEF; --text-main: #212529; --text-sub: #6C757D;
      --red: #FF6B6B; --green: #51CF66; --purple: #AE72FF;
    }
    * { box-sizing: border-box; }
    body { background: var(--bg); font-family: 'Nanum Gothic', sans-serif; margin: 0; color: var(--text-main); line-height: 1.6; }
    
    nav { background: var(--navy); display: flex; justify-content: space-between; align-items: center; padding: 10px 40px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .nav-links { display: flex; gap: 20px; }
    .nav-links a { color: var(--white); text-decoration: none; font-weight: 700; font-size: 0.85rem; cursor: pointer; }
    .nav-links a.active, .nav-links a:hover { color: var(--yellow); }
    .user-info { color: rgba(255, 201, 71, 0.4); font-size: 0.45rem; display: flex; align-items: center; gap: 5px; }
    .logout-btn { background: none; border: none; color: rgba(255, 255, 255, 0.3); cursor: pointer; font-size: 0.4rem; text-decoration: underline; padding: 0; }

    header { background: var(--navy); color: var(--white); padding: 40px 20px; text-align: center; border-bottom: 6px solid var(--yellow); }
    .brand-icon { font-size: 3.5rem; margin-bottom: 10px; display: block; }
    header h1 { font-size: 2.2rem; margin: 0; color: var(--yellow); letter-spacing: 4px; font-weight: 800; }
    header p { opacity: 0.7; margin-top: 10px; font-size: 0.9rem; }

    .content-layer { display: none; max-width: 960px; margin: 40px auto; padding: 0 20px; }
    .content-layer.active { display: block; animation: fadeInUp 0.4s ease-out; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .card { background: var(--white); border: 1px solid var(--border); border-radius: 16px; padding: 35px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
    .card-title { font-size: 1.25rem; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--navy); }
    .card-title::before { content: ''; width: 4px; height: 20px; background: var(--yellow); border-radius: 2px; }

    .novel-list-item { display: flex; justify-content: space-between; align-items: center; padding: 20px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; cursor: pointer; transition: 0.2s; background: #fff; }
    .novel-list-item:hover { border-color: var(--yellow); transform: translateX(5px); }
    
    .back-btn { display: inline-block; margin-bottom: 20px; color: var(--text-sub); cursor: pointer; font-size: 0.9rem; font-weight: 800; }
    .progress-bg { background: #eee; height: 14px; border-radius: 7px; overflow: hidden; margin: 20px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--navy), #185ADB); width: 0%; transition: 1s; }
    .novel-body { background: #fff; padding: 30px; border: 1px solid var(--border); border-radius: 12px; margin-top: 20px; white-space: pre-wrap; font-size: 1.05rem; line-height: 1.9; }

    input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1.5px solid var(--border); border-radius: 10px; font-family: inherit; }
    .btn { background: var(--navy); color: var(--yellow); border: none; padding: 14px 28px; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.3s; width: 100%; }
    .btn:hover { background: #162D50; transform: translateY(-2px); }
    .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; }

    .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
    .book-card { background: var(--white); border: 1px solid var(--border); border-radius: 14px; padding: 15px; text-align: center; }
    .book-img-wrapper { width: 100%; height: 300px; background-color: #f0f0f0; border-radius: 10px; overflow: hidden; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; }
    .book-card img { max-width: 100%; max-height: 100%; object-fit: contain; }
  </style>
</head>
<body>

<nav>
  <div class="nav-links">
    <a onclick="showPage('home')" id="link-home">HOME</a>
    <a onclick="showPage('writer')" id="link-writer">WRITER</a>
    <a onclick="showPage('reader')" id="link-reader">READER</a>
    <a onclick="showPage('published')" id="link-published">PUBLISHED</a>
    <a onclick="showPage('mypage')" id="link-mypage">MY PAGE</a>
    <a onclick="showPage('admin')" id="link-admin" style="display:none; color:var(--purple);">ADMIN</a>
  </div>
  <div id="auth-nav" class="user-info"></div>
</nav>

<header>
  <span class="brand-icon">ğŸ£</span>
  <h1>RIVAL; REVIVAL</h1>
  <p>ì •ì§í•œ í•œ í‘œê°€ ì‘ê°€ì˜ ê¿ˆì„ ê¹¨ì›ë‹ˆë‹¤</p>
</header>

<div id="home" class="content-layer active">
  <div id="auth-ui"></div>
  <div class="card">
    <div class="card-title">ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€ ì•ˆë‚´</div>
    <p style="font-size:0.9rem; color:var(--text-sub);">
        RIVAL; REVIVALì€ ê³µì •í•œ í€ë”©ì„ ìœ„í•´ **1ì¸ 1ì‘ê°€ 1íšŒ íˆ¬í‘œ**ë¥¼ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤.<br>
        ìƒë…„ì›”ì¼ê³¼ ì—°ë½ì²˜ ê¸°ë°˜ì˜ ê²€ì¦ì„ í†µí•´ ë¶€ì • íˆ¬í‘œë¥¼ ì—„ê²©íˆ ì œí•œí•˜ê³  ìˆìŠµë‹ˆë‹¤.
    </p>
  </div>
</div>

<div id="reader" class="content-layer">
  <div id="reader-list-view">
    <div class="card">
      <div class="card-title">ì›ê³  ëª©ë¡</div>
      <div id="novel-list"></div>
    </div>
  </div>
  <div id="reader-detail-view" style="display:none;">
    <div class="back-btn" onclick="toggleReaderView('list')">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</div>
    <div id="novel-detail-content"></div>
  </div>
</div>

<div id="writer" class="content-layer"><div class="card"><div class="card-title">ì›ê³  íˆ¬ê³ ì‹¤</div><div id="writer-form-area"></div></div></div>
<div id="published" class="content-layer"><div class="card"><div class="card-title">ê³µì‹ ì¶œíŒ ëª©ë¡</div><div id="published-grid" class="book-grid"></div></div></div>

<div id="mypage" class="content-layer">
  <div class="card">
    <div class="card-title">ë‚˜ì˜ í™œë™ ëŒ€ì‹œë³´ë“œ</div>
    <div id="mypage-content"></div>
    <div style="margin-top:40px; text-align:right;"><span style="color:var(--red); cursor:pointer; font-size:0.8rem; text-decoration:underline;" onclick="processLeave()">ê³„ì • íƒˆí‡´</span></div>
  </div>
</div>

<div id="admin" class="content-layer">
  <div class="card">
    <div class="card-title" style="color:var(--purple);">ê³µì‹ ë„ì„œ ë“±ë¡</div>
    <input type="text" id="pub-title" placeholder="ë„ì„œ ì œëª©"><div style="border: 2px dashed var(--border); padding: 30px; text-align: center; cursor: pointer; border-radius: 12px; margin-bottom: 20px;" onclick="document.getElementById('pub-file').click()"><span id="file-name">í‘œì§€ ì´ë¯¸ì§€ ì„ íƒ</span><input type="file" id="pub-file" accept="image/*" style="display:none" onchange="optimizeAndPreview(this)"></div><input type="hidden" id="pub-img-data"><button class="btn" style="background:var(--purple); color:white;" onclick="addPublishedBook()">ë“±ë¡í•˜ê¸°</button></div>
  <div class="card"><div class="card-title">ë“±ë¡ ë„ì„œ ê´€ë¦¬</div><div id="admin-book-manage"></div></div>
</div>

<script>
  let users = JSON.parse(localStorage.getItem('rv_users')) || [];
  let currentUser = JSON.parse(localStorage.getItem('rv_current')) || null;
  let novels = JSON.parse(localStorage.getItem('rv_novels')) || [];
  let publishedBooks = JSON.parse(localStorage.getItem('rv_books')) || [];
  let fundHistory = JSON.parse(localStorage.getItem('rv_fund_history')) || {};
  let reviews = JSON.parse(localStorage.getItem('rv_reviews')) || {};
  let voteLog = JSON.parse(localStorage.getItem('rv_vote_log')) || {}; // { "ìƒë…„ì›”ì¼_ì „í™”ë²ˆí˜¸_ì‘ê°€ID": true }

  const GOAL = 10000; const PRICE = 500;
  const ADMIN_CONFIG = { id: "admin", pw: "kt91107361!" };

  // ê¸°ê¸° ì‹ë³„ì (Browser ID) ìƒì„± ë° ì²´í¬
  if(!localStorage.getItem('rv_device_id')) {
    localStorage.setItem('rv_device_id', 'DEV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9));
  }
  const DEVICE_ID = localStorage.getItem('rv_device_id');

  function showPage(id) {
    if (id === 'admin' && (!currentUser || currentUser.id !== ADMIN_CONFIG.id)) { alert("ê¶Œí•œ ì—†ìŒ"); return; }
    document.querySelectorAll('.content-layer').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('link-' + id).classList.add('active');
    
    if(id === 'writer') renderWriterForm();
    if(id === 'reader') toggleReaderView('list');
    if(id === 'published') renderPublished();
    if(id === 'mypage') renderMyPage();
    if(id === 'admin') renderAdminManage();
    updateUI();
  }

  function toggleReaderView(view) {
    const listArea = document.getElementById('reader-list-view');
    const detailArea = document.getElementById('reader-detail-view');
    if(view === 'list') { listArea.style.display = 'block'; detailArea.style.display = 'none'; renderNovels(); }
    else { listArea.style.display = 'none'; detailArea.style.display = 'block'; }
  }

  function renderNovels() {
    const list = document.getElementById('novel-list');
    list.innerHTML = novels.length === 0 ? "<p style='text-align:center;'>ì›ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>" : "";
    novels.slice().reverse().forEach(n => {
      const div = document.createElement('div');
      div.className = 'novel-list-item';
      div.onclick = () => showNovelDetail(n.id);
      div.innerHTML = `<div><span style="font-weight:800; font-size:1.1rem;">ã€${n.title}ã€</span><br><small>ì‘ê°€: ${n.author}</small></div><div style="font-weight:800; color:var(--text-sub);">â˜… ${n.stars.toLocaleString()}</div>`;
      list.appendChild(div);
    });
  }

  function showNovelDetail(id) {
    const n = novels.find(x => x.id === id);
    const per = Math.min((n.stars / GOAL) * 100, 100).toFixed(1);
    const isFunded = currentUser && fundHistory[currentUser.id] && fundHistory[currentUser.id].includes(id);
    const novelReviews = reviews[id] || [];

    const detailContent = document.getElementById('novel-detail-content');
    detailContent.innerHTML = `
      <div class="card">
        <div class="card-title">ã€${n.title}ã€ ìƒì„¸ ì •ë³´</div>
        <div class="progress-bg"><div class="progress-fill" style="width:${per}%"></div></div>
        <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight:800;">
          <span>ë‹¬ì„±ë¥  ${per}%</span>
          <span>ì§€ì›ê¸ˆ ${(n.stars * PRICE).toLocaleString()}ì›</span>
        </div>
        <button class="btn" style="margin-top:20px; background:var(--yellow); color:var(--navy);" onclick="vote(${n.id}, '${n.authorId}')">â˜… ë³„ì  ì£¼ê¸° (í€ë”©)</button>
      </div>
      ${isFunded ? `
        <div class="card">
          <div class="card-title">ì›ê³  ì „ë¬¸</div>
          <div class="novel-body">${n.content}</div>
        </div>
        <div class="card">
          <div class="card-title">ë…ì ì„œí‰</div>
          <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="rev-input" placeholder="í•œ ì¤„ ì„œí‰ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.">
            <button class="btn btn-sm" onclick="addReview(${n.id})">ë“±ë¡</button>
          </div>
          <div id="review-list-area">
            ${novelReviews.map(r => `<div class="review-item"><strong>${r.author}:</strong> ${r.text}</div>`).reverse().join('')}
          </div>
        </div>
      ` : `
        <div class="card" style="text-align:center; border: 2px dashed var(--border);"><p>ğŸ”’ í€ë”© ì°¸ì—¬ í›„ ëª¨ë“  ë‚´ìš©ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div>
      `}
    `;
    toggleReaderView('detail');
  }

  // ì¤‘ë³µ íˆ¬í‘œ ë°©ì§€ í•µì‹¬ ë¡œì§
  function vote(novelId, authorId) {
    if(!currentUser || currentUser.role !== 'reader') return alert("ë…ì íšŒì›ë§Œ í€ë”©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    
    // 1. ì •ë³´ ê¸°ë°˜ ì¤‘ë³µ ì²´í¬ (ìƒë…„ì›”ì¼ + ì „í™”ë²ˆí˜¸ + ì‘ê°€ID)
    const voteKey = `${currentUser.birth}_${currentUser.phone}_${authorId}`;
    if(voteLog[voteKey]) return alert("ë¶€ì • íˆ¬í‘œ ë°©ì§€: ì´ë¯¸ ì´ ì‘ê°€ë‹˜ì—ê²Œ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤. (1ì¸ 1ì‘ê°€ 1íšŒ ì œí•œ)");

    const i = novels.findIndex(n => n.id === novelId); 
    novels[i].stars += 1;
    voteLog[voteKey] = true;

    if(!fundHistory[currentUser.id]) fundHistory[currentUser.id] = [];
    if(!fundHistory[currentUser.id].includes(novelId)) fundHistory[currentUser.id].push(novelId);
    
    localStorage.setItem('rv_novels', JSON.stringify(novels));
    localStorage.setItem('rv_fund_history', JSON.stringify(fundHistory));
    localStorage.setItem('rv_vote_log', JSON.stringify(voteLog));
    
    alert("ì†Œì¤‘í•œ í•œ í‘œ ê°ì‚¬í•©ë‹ˆë‹¤!");
    showNovelDetail(novelId);
  }

  function addReview(novelId) {
    const input = document.getElementById('rev-input');
    if(!input.value.trim()) return alert("ë‚´ìš© ì…ë ¥");
    if(!reviews[novelId]) reviews[novelId] = [];
    reviews[novelId].push({ author: currentUser.name, authorId: currentUser.id, text: input.value });
    localStorage.setItem('rv_reviews', JSON.stringify(reviews));
    showNovelDetail(novelId);
  }

  function renderMyPage() {
    const area = document.getElementById('mypage-content');
    if(!currentUser) return area.innerHTML = "ë¡œê·¸ì¸ í•„ìš”";
    
    if(currentUser.role === 'writer') {
      const myNovels = novels.filter(n => n.authorId === currentUser.id);
      area.innerHTML = `<h4>ë‚˜ì˜ íˆ¬ê³  ì›ê³  (${myNovels.length})</h4>`;
      myNovels.forEach(n => { area.innerHTML += `<div class="novel-list-item" style="cursor:default"><div><b>${n.title}</b></div><div>â˜… ${n.stars}</div></div>`; });
    } else {
      let myReviewsCount = 0;
      let reviewHtml = `<h4>ë‚´ê°€ ì‘ì„±í•œ ì„œí‰</h4>`;
      Object.keys(reviews).forEach(novelId => {
        const novel = novels.find(x => x.id == novelId);
        reviews[novelId].forEach(r => {
          if(r.authorId === currentUser.id) {
            myReviewsCount++;
            reviewHtml += `<div class="review-item"><b>[${novel ? novel.title : 'ì›ê³ '}]</b> ${r.text}</div>`;
          }
        });
      });
      area.innerHTML = myReviewsCount === 0 ? "<p>ê¸°ë¡ ì—†ìŒ</p>" : reviewHtml;
    }
  }

  function renderAuthUI() {
    const area = document.getElementById('auth-ui');
    if(currentUser) { area.innerHTML = `<div style="text-align:center; padding:10px;">ë°˜ê°‘ìŠµë‹ˆë‹¤, ${currentUser.name}ë‹˜.</div>`; }
    else { area.innerHTML = `<div class="card" style="max-width:400px; margin:0 auto;"><input type="text" id="li-id" placeholder="ID"><input type="password" id="li-pw" placeholder="PW"><button class="btn" onclick="login()">LOGIN</button><hr style="margin:20px 0; border:0; border-top:1px solid #eee;"><select id="rg-role"><option value="writer">ì‘ê°€ ê°€ì…</option><option value="reader">ë…ì ê°€ì…</option></select><input type="text" id="rg-id" placeholder="ID"><input type="password" id="rg-pw" placeholder="PW"><input type="text" id="rg-name" placeholder="Name"><input type="text" id="rg-birth" placeholder="ìƒë…„ì›”ì¼ 8ìë¦¬ (19900101)"><input type="text" id="rg-phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ (-ì—†ì´ ìˆ«ìë§Œ)"><button class="btn" style="background:#eee; color:#333;" onclick="signup()">JOIN</button></div>`; }
  }

  function signup() {
    const role = document.getElementById('rg-role').value; const id = document.getElementById('rg-id').value;
    const pw = document.getElementById('rg-pw').value; const name = document.getElementById('rg-name').value;
    const birth = document.getElementById('rg-birth').value; const phone = document.getElementById('rg-phone').value;
    
    if(!id || !pw || !name || birth.length !== 8 || !phone) return alert("ê°€ì… ì •ë³´ë¥¼ ëª¨ë‘ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.");
    
    // ì „í™”ë²ˆí˜¸/ìƒë…„ì›”ì¼ ì¤‘ë³µ ê°€ì… ë°©ì§€ ë¡œì§
    if(users.find(u => u.phone === phone && u.birth === birth)) return alert("ì´ë¯¸ ë™ì¼í•œ ì •ë³´ë¡œ ê°€ì…ëœ ê³„ì •ì´ ìˆìŠµë‹ˆë‹¤.");
    if(users.find(u => u.id === id)) return alert("ì¤‘ë³µëœ ì•„ì´ë””ì…ë‹ˆë‹¤.");

    users.push({id, pw, name, role, birth, phone, deviceId: DEVICE_ID});
    localStorage.setItem('rv_users', JSON.stringify(users)); alert("í™˜ì˜í•©ë‹ˆë‹¤! ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."); renderAuthUI();
  }

  function login() {
    const id = document.getElementById('li-id').value; const pw = document.getElementById('li-pw').value;
    if(id === ADMIN_CONFIG.id && pw === ADMIN_CONFIG.pw) currentUser = { id: 'admin', name: 'ê´€ë¦¬ì', role: 'admin' };
    else { const user = users.find(u => u.id === id && u.pw === pw); if(!user) return alert("ì˜¤ë¥˜"); currentUser = user; }
    localStorage.setItem('rv_current', JSON.stringify(currentUser)); showPage('home');
  }

  function updateUI() {
    const nav = document.getElementById('auth-nav');
    if(currentUser) { nav.innerHTML = `${currentUser.name}ë‹˜ <button class="logout-btn" onclick="logout()">[LOGOUT]</button>`; document.getElementById('link-admin').style.display = (currentUser.id === ADMIN_CONFIG.id) ? 'inline-block' : 'none'; }
    else { nav.innerHTML = "LOGIN"; document.getElementById('link-admin').style.display = 'none'; }
    if(document.getElementById('home').classList.contains('active')) renderAuthUI();
  }
  function logout() { currentUser = null; localStorage.removeItem('rv_current'); showPage('home'); }
  function renderWriterForm() { const area = document.getElementById('writer-form-area'); if(!currentUser || currentUser.role !== 'writer') { area.innerHTML = "<p>ì‘ê°€ ì „ìš©</p>"; return; } area.innerHTML = `<input type="text" id="wt-title" placeholder="ì œëª©"><textarea id="wt-content" rows="10" placeholder="ë‚´ìš©"></textarea><button class="btn" onclick="saveNovel()">ê²Œì‹œ</button>`; }
  function saveNovel() { novels.push({ id: Date.now(), author: currentUser.name, authorId: currentUser.id, title: document.getElementById('wt-title').value, content: document.getElementById('wt-content').value, stars: 0 }); localStorage.setItem('rv_novels', JSON.stringify(novels)); showPage('reader'); }
  function renderPublished() { const grid = document.getElementById('published-grid'); grid.innerHTML = publishedBooks.length === 0 ? "ì—†ìŒ" : publishedBooks.map(b => `<div class="book-card"><div class="book-img-wrapper"><img src="${b.img}"></div><h3>${b.title}</h3></div>`).join(''); }
  function renderAdminManage() { const area = document.getElementById('admin-book-manage'); area.innerHTML = publishedBooks.length === 0 ? "ë„ì„œ ì—†ìŒ" : publishedBooks.map((b, idx) => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${b.title}</span><button class="btn btn-sm" style="background:var(--red); color:#fff;" onclick="deleteBook(${idx})">ì‚­ì œ</button></div>`).join(''); }
  function deleteBook(idx) { if(confirm("ì‚­ì œ?")) { publishedBooks.splice(idx, 1); localStorage.setItem('rv_books', JSON.stringify(publishedBooks)); renderAdminManage(); } }
  function addPublishedBook() { const t = document.getElementById('pub-title').value; const m = document.getElementById('pub-img-data').value; if(!t || !m) return alert("ì •ë³´"); publishedBooks.push({ title: t, img: m }); localStorage.setItem('rv_books', JSON.stringify(publishedBooks)); showPage('published'); }
  function processLeave() { if(confirm("íƒˆí‡´?")) { users = users.filter(u => u.id !== currentUser.id); localStorage.setItem('rv_users', JSON.stringify(users)); logout(); } }
  function optimizeAndPreview(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = e => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height, max = 800; if(w > h) { if(w > max) { h *= max/w; w = max; } } else { if(h > max) { w *= max/h; h = max; } } canvas.width = w; canvas.height = h; canvas.getContext('2d').drawImage(img, 0, 0, w, h); document.getElementById('pub-img-data').value = canvas.toDataURL('image/jpeg', 0.8); document.getElementById('file-name').innerText = "OK"; }; img.src = e.target.result; }; reader.readAsDataURL(file); }

  showPage('home');
</script>
</body>
</html>